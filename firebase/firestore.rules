rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: true if caller has admin custom claim
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // ----- organizationIntakes -----
    match /organizationIntakes/{intakeId} {
      allow create: if request.auth != null
        && request.resource.data.status == "draft"
        && request.resource.data.userId == request.auth.uid
        && !request.resource.data.keys().hasAny(["paymentIntentId", "latestEventId"]);
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // ----- payments (server-only) -----
    match /payments/{paymentIntentId} {
      allow read, write: if false;
    }

    // ----- users -----
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      match /donations/{donationId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false;
      }
      match /requests/{requestId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /prayers/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /prayerDays/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /ramadanLogs/{dateString} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /reelInteractions/{reelId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ----- reels (global feed; authenticated read; isActive == true) -----
    match /reels/{reelId} {
      allow read: if request.auth != null && resource.data.isActive == true;
      allow write: if false;
    }

    // ----- app_config (calendar flags e.g. Ramadan; read-only for authenticated) -----
    match /app_config/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // ----- donations (legacy top-level; server-only; client uses users/{uid}/donations) -----
    match /donations/{docId} {
      allow read, write: if false;
    }

    // ----- charities -----
    match /charities/{charityId} {
      allow read: if true;
      allow write: if false;
    }

    // ----- global requests (admin-only; regular users must not read/write) -----
    match /requests/{requestId} {
      allow read, write: if isAdmin();
    }

    // ----- reports (any auth user can create; only admin can read) -----
    match /reports/{reportId} {
      allow create: if request.auth != null;
      allow read, delete: if isAdmin();
      allow update: if false;
    }

    // ----- credit_conversion_requests (user: own docs only; admin: read all) -----
    match /credit_conversion_requests/{docId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ----- admin collections (admin-only) -----
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
